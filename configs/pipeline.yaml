# Pipeline Configuration - Intelligent Training Data Generation

# ==================== Repository Configuration ====================
repo:
  path: "./repos/java/online_shopping_be"              # Path to Java repository (required)
  commit: ""                        # Git commit hash (empty = auto-detect from git)

# ==================== Filter Configuration ====================
filter:
  ignore_paths:
    - "test"
    - "tests"
    - ".git"
    - "target"
    - "build"
    - "node_modules"
    - ".idea"
    - ".vscode"
    - "bin"
    - "out"
  file_extensions:
    - ".java"

# ==================== Parser Configuration ====================
parser:
  type: "java"
  max_chars_per_symbol: 12000       # Maximum characters per symbol (truncation threshold)
  include_private: false
  include_test: false

# ==================== Generation Configuration ====================
generation:
  run_llm: true                     # Enable/disable LLM calls (false = dry run)
  max_context_chars: 16000          # Maximum context characters for LLM
  batch_size: 5                     # Batch size for generation
  top_k_context: 6                  # Top-K context selection for RAG
  temperature: 0.7                  # LLM temperature (0.0-1.0)

# ==================== QA Generator Configuration ====================
qa_generator:
  max_context_chars: 16000
  batch_size: 5
  max_samples: 50
  priority_annotations:
    - "Transactional"
    - "GetMapping"
    - "PostMapping"
    - "PutMapping"
    - "DeleteMapping"
    - "RequestMapping"
    - "Service"
    - "RestController"
    - "Controller"

# ==================== Design Generator Configuration ====================
design_generator:
  top_k_context: 6
  max_context_chars: 20000
  max_samples: 10
  require_min_evidence: 2

# ==================== LLM Configuration ====================
llm:
  provider: "ollama"
  base_url: "http://localhost:11434/v1"
  model: "qwen2.5:7b"
  temperature: 0.7
  max_tokens: 2000
  timeout: 60

# ==================== Quality Control Configuration ====================
quality:
  min_instruction_length: 10
  min_answer_length: 20
  max_answer_length: 2000
  enable_deduplication: true

# ==================== Deduplication Configuration ====================
dedup:
  simhash_bits: 64                  # Simhash fingerprint bits
  max_hamming: 3                    # Maximum hamming distance for near-duplicates
  seed: 42

# ==================== Split Configuration ====================
split:
  train_ratio: 0.8                  # Training set ratio
  val_ratio: 0.1                    # Validation set ratio
  test_ratio: 0.1                   # Test set ratio
  seed: 42                          # Random seed for reproducibility
  group_by: "package"               # Grouping strategy: "package" or "path"

# ==================== Safety & Compliance Configuration ====================
safety:
  mode: "drop"                      # Mode: "drop" (remove samples) or "sanitize" (redact secrets)
  scan_enabled: true

# ==================== Export Configuration ====================
export:
  system_prompt: |
    你是一个专业的代码助手，精通 Java 开发和架构设计。
    你的任务是根据提供的代码上下文，准确回答问题或提供设计方案。
    你必须基于 evidence（证据）进行推理，确保答案可追溯到具体代码。
    在回答时，注重实用性和可操作性，避免过于抽象的描述。

# ==================== Output Paths Configuration ====================
paths:
  # Raw outputs
  symbols_jsonl: "data/raw/extracted/symbols.jsonl"
  repo_meta_json: "data/raw/repo_meta/repo_meta.json"
  
  # Intermediate outputs
  intermediate_dir: "data/intermediate"
  qa_raw_jsonl: "data/intermediate/qa_raw.jsonl"
  qa_rejected_jsonl: "data/intermediate/qa_rejected.jsonl"
  design_raw_jsonl: "data/intermediate/design_raw.jsonl"
  design_rejected_jsonl: "data/intermediate/design_rejected.jsonl"
  all_raw_jsonl: "data/intermediate/all_raw.jsonl"
  all_dedup_jsonl: "data/intermediate/all_dedup.jsonl"
  
  # Final outputs
  final_dir: "data/final"
  train_jsonl: "data/final/train.jsonl"
  val_jsonl: "data/final/val.jsonl"
  test_jsonl: "data/final/test.jsonl"
  train_sft_jsonl: "data/final/train_sft.jsonl"
  val_sft_jsonl: "data/final/val_sft.jsonl"
  test_sft_jsonl: "data/final/test_sft.jsonl"
  
  # Reports
  reports_dir: "data/reports"
  qa_quality_json: "data/reports/qa_quality.json"
  design_quality_json: "data/reports/design_quality.json"
  dedup_mapping_json: "data/reports/dedup_mapping.json"
  secrets_dropped_jsonl: "data/reports/secrets_dropped.jsonl"
  pipeline_summary_json: "data/reports/pipeline_summary.json"
  dataset_stats_json: "data/reports/dataset_stats.json"

# ==================== Output Directory Configuration (Backward Compatibility) ====================
output:
  raw_extracted: "data/raw/extracted"
  raw_repo_meta: "data/raw/repo_meta"
  intermediate: "data/intermediate"
  final: "data/final"
  reports: "data/reports"

# ==================== Logging Configuration ====================
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "logs/pipeline.log"

# ==================== Advanced Configuration ====================
advanced:
  enable_cache: true
  cache_dir: ".cache"
  parallel_workers: 4
  checkpoint_interval: 100

# ==================== Auto Module Configuration ====================
auto:
  enabled: true                                       # Enable auto module (default: disabled)
  max_methods: 30                                     # Maximum methods to process (cost control)
  questions_per_method: 5                             # Number of questions per method
  top_k_context: 6                                    # Top-K methods for context retrieval
  embedding_model: "nomic-embed-text"                 # Ollama embedding model
  prompts:
    method_understanding: "configs/prompts/auto_method_understanding.txt"
    question_generation: "configs/prompts/auto_question_generation.txt"
    answer_generation: "configs/prompts/auto_answer_generation.txt"
  outputs:
    method_profiles_jsonl: "data/intermediate/method_profiles.jsonl"
    method_understanding_rejected_jsonl: "data/intermediate/auto_method_understanding_rejected.jsonl"
    questions_jsonl: "data/intermediate/questions.jsonl"
    embeddings_jsonl: "data/intermediate/method_embeddings.jsonl"
    auto_qa_raw_jsonl: "data/intermediate/auto_qa_raw.jsonl"
    auto_answer_rejected_jsonl: "data/intermediate/auto_answer_rejected.jsonl"